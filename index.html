<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>住戶姓名 → 住址 即時查詢（固定讀檔版）</title>
  <style>
    :root { --radius: 14px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Arial, "微軟正黑體", sans-serif; margin:0; padding:24px; background:#f7f7fb; }
    .wrap { max-width:820px; margin:0 auto; }
    h1 { font-size:20px; margin:0 0 14px; }
    .card { background:#fff; border-radius:14px; box-shadow:0 8px 18px rgba(0,0,0,.06); padding:18px; }
    input[type="text"]{ width:100%; padding:12px 14px; border:1px solid #dcdce6; border-radius:12px; font-size:16px; outline:none; }
    input[type="text"]:focus{ border-color:#7b8cff; box-shadow:0 0 0 3px rgba(123,140,255,.15); }
    .list{ position:relative; margin-top:8px; border:1px solid #e6e6ef; border-radius:12px; background:#fff; max-height:280px; overflow:auto; display:none; }
    .item{ padding:10px 12px; display:flex; justify-content:space-between; gap:12px; cursor:pointer; }
    .item:nth-child(2n){ background:#fafafe; }
    .item:hover{ background:#eef1ff; }
    .name{ font-weight:600; } .meta{ color:#6a6a75; font-size:13px; white-space:nowrap; }
    .result{ margin-top:14px; border-top:1px dashed #e1e1ea; padding-top:12px; }
    .rowline{ display:grid; grid-template-columns:100px 1fr; gap:12px; padding:6px 0; }
    .mini{ font-size:12px; color:#7a7a88; } .ok{ color:#2f8f46; font-weight:600; } .err{ color:#c0392b; font-weight:600; } .warn{ color:#d48806; font-weight:600; }
    mark{ background:#ffeaa7; }
    .actions{ display:flex; gap:8px; margin-top:8px; }
    .btn{ padding:8px 10px; border-radius:10px; border:1px solid #dcdce6; background:#fff; cursor:pointer; font-size:14px; }
    .btn:hover{ background:#f2f4ff; border-color:#bfc7ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>住戶姓名 → 住址 即時查詢（固定讀檔版）</h1>
    <div class="card">
      <label for="q" class="mini">輸入任一字元，即時列出「名字包含此字」的住戶</label>
      <input id="q" type="text" placeholder="例如：阿、王、小…" autocomplete="off" />
      <div id="list" class="list"></div>
      <div id="result" class="result" style="display:none"></div>
      <div class="actions">
        <button id="reload" class="btn">重新載入資料</button>
        <span class="mini">狀態：<span id="state" class="warn">尚未載入</span></span>
      </div>
      <div class="mini" style="margin-top:6px">※ 本頁永遠從 <code>./residents.csv</code> 讀取。請將它與 <code>index.html</code> 放同一資料夾；更新時直接覆蓋檔案。</div>
    </div>
  </div>

<script>
const $ = (s, el=document)=>el.querySelector(s);
const $$ = (s, el=document)=>Array.from(el.querySelectorAll(s));

// 極簡 CSV 解析（支援引號與逗號）
function parseCSV(text){
  const rows=[]; let row=[], cell='', inQ=false;
  for (let i=0;i<text.length;i++){ const c=text[i], n=text[i+1];
    if(inQ){ if(c=='"'&&n=='"'){cell+='"'; i++;} else if(c=='"'){inQ=false;} else {cell+=c;} }
    else{ if(c=='"'){inQ=true;} else if(c==','){row.push(cell); cell='';}
      else if(c=='\n'){row.push(cell); rows.push(row); row=[]; cell='';}
      else if(c=='\r'){} else {cell+=c;} }
  }
  if(cell.length>0 || row.length>0){ row.push(cell); rows.push(row); }
  return rows;
}

function toRecords(rows){
  if(!rows.length) return [];
  const header = rows[0].map(h=>h.trim().toLowerCase());
  const idx = alts=>alts.map(a=>header.indexOf(a)).find(i=>i>=0);
  const nameIdx = idx(['姓名','name']);
  const addrIdx = idx(['住址','address']);
  const bldgIdx = idx(['棟','building']);
  const doorIdx = idx(['門牌','門牌號','door_no','doorno']);
  const recs=[];
  for(let i=1;i<rows.length;i++){
    const r=rows[i];
    const name = r[nameIdx]?r[nameIdx].trim():'';
    const addr = r[addrIdx]?r[addrIdx].trim():'';
    if(!name || !addr) continue;
    recs.push({ name, address: addr, building: bldgIdx>=0 ? (r[bldgIdx]||'').trim() : '', door: doorIdx>=0 ? (r[doorIdx]||'').trim() : '' });
  }
  return recs;
}

let records=[];
async function loadCSV(){
  $('#state').textContent='載入中…'; $('#state').className='mini';
  try{
    const res = await fetch('residents.csv?v='+Date.now(), {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text = await res.text();
    const rows = parseCSV(text);
    records = toRecords(rows);
    const n = records.length;
    $('#state').textContent = n ? `已載入 ${n} 筆` : '載入 0 筆（檢查欄位：姓名/住址）';
    $('#state').className = n ? 'ok' : 'warn';
  }catch(e){
    console.error(e);
    $('#state').textContent='載入失敗（找不到 residents.csv 或存取路徑不對）';
    $('#state').className='err';
  }
}

// 篩選與渲染
const q=$('#q'), list=$('#list'), result=$('#result');
let t;
function highlight(text, needle){
  if(!needle) return text;
  const esc = needle.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  return text.replace(new RegExp(esc,'gi'), m=>`<mark>${m}</mark>`);
}
function filterRecords(needle){
  const n=(needle||'').trim(); if(!n) return [];
  return records.filter(r=>r.name.toLowerCase().includes(n.toLowerCase())).slice(0,200);
}
function renderList(items, needle){
  if(!items.length){ list.style.display='none'; return; }
  list.innerHTML = items.map(r=>`<div class="item"><div class="name">${highlight(r.name, needle)}</div><div class="meta">${[r.building, r.door].filter(Boolean).join(' ')}</div></div>`).join('');
  list.style.display='block';
  $$('.item', list).forEach((el, i)=>{
    el.addEventListener('click', ()=>selectItem(items[i]));
  });
}
function selectItem(rec){
  list.style.display='none';
  q.value = rec.name;
  result.style.display='block';
  result.innerHTML = `<div class="rowline"><div>姓名</div><div><strong>${rec.name}</strong></div></div>
                      <div class="rowline"><div>住址</div><div>${rec.address}</div></div>
                      ${rec.building||rec.door?`<div class="rowline"><div>其他</div><div>${[rec.building, rec.door].filter(Boolean).join(' / ')}</div></div>`:''}`;
}

// 綁定
q.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(()=>{ renderList(filterRecords(q.value), q.value); }, 80); });
$('#reload').addEventListener('click', loadCSV);

// 啟動
loadCSV();
</script>
</body>
</html>
